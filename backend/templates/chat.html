<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API Request</title>

    <script src="https://cdn.tailwindcss.com"></script>

</head>

<body class="relative w-full h-full bg-cover bg-no-repeat"
    style="background-image: url('https://duri.sgp1.cdn.digitaloceanspaces.com/bg/mainEntrance.jpg');" id="body_bg">

    <div class="h-[100vh] w-full bg-black/70 absolute flex justify-center items-center" id="name">
        <div
            class=" p-6 w-[500px] flex-col text-white font-bold text-lg h-fit bg-gradient-to-t from-cyan-200/40 to-cyan-800 7/23/24 60 rounded-md bg-clip-padding backdrop-filter backdrop-blur-sm bg-opacity-80 border border-gray-100 flex flex-row justify-between gap-12">
            <h2>What's Your Name?</h2>
            <input type="text" placeholder="Name" class="p-2 rounded-md text-black" id="usernameInput">
            <button onclick="hideAndStore()" class="w-full bg-cyan-600 p-4 rounded-lg">Submit</button>
        </div>
    </div>

    <script>
        // Global variable to store the username
        let username;

        function hideAndStore() {
            // Get the input value
            username = document.getElementById("usernameInput").value;

            // Check if the input is not empty
            if (username.trim() !== "") {
                // Hide the div
                document.getElementById("name").style.display = "none";
                document.getElementById("chatbox").classList.remove("hidden");
                document.getElementById("duri").classList.remove("hidden");

                // Do something with the username if needed
                console.log("Username:", username);
            } else {
                // Display an alert or take any other appropriate action
                alert("Please enter a username.");
            }
        }
    </script>

    <div class="hidden flex justify-center items-center  h-[700px] overflow-y-hidden"  id="duri">
        <img src="https://duri.sgp1.cdn.digitaloceanspaces.com/characters/joyful.svg" class="w-[400px] pb-12 " alt=""
            id="character_id">
    </div>

    <div  id="chatbox"
        class="hidden absolute top-16 left-[200px] lg:left-[500px] p-6 w-[500px] mt-[200px] md:mt-[450px] text-white  font-bold text-lg h-fit bg-gradient-to-t from-cyan-200/40 to-cyan-800 rounded-md bg-clip-padding backdrop-filter backdrop-blur-sm bg-opacity-80 border border-gray-100 flex flex-row justify-between gap-12">

        <div class="w-11/12">
            <h2 id="response_gpt">Hello Hello There My Friend. Can I know your name?</h2>
        </div>
        <div class="w-1/12">
            <button id="recordButton" onclick="toggleRecording()" class="w-12 h-12"> <svg
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path fill="white"
                        d="M4.5 10a.5.5 0 0 0-1 0a5.5 5.5 0 0 0 5 5.478V17.5a.5.5 0 0 0 1 0v-.706A5.48 5.48 0 0 1 9 14.5A4.5 4.5 0 0 1 4.5 10ZM12 5v4.6a5.514 5.514 0 0 0-2.79 3.393A3 3 0 0 1 6 10V5a3 3 0 0 1 6 0Zm5 9.5a2.5 2.5 0 1 1-5 0a2.5 2.5 0 0 1 5 0Zm2 0a4.5 4.5 0 1 1-9 0a4.5 4.5 0 0 1 9 0Zm-8 0a3.5 3.5 0 1 0 7 0a3.5 3.5 0 0 0-7 0Z" />
                </svg></button>

        </div>
    </div>
    <audio id="myAudio" controls style="display: none;">
        <source src="https://hackaten.sgp1.cdn.digitaloceanspaces.com/Duri/Music/characterSelectMusic.mp3"
            type="audio/mp3">
    </audio>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var audio = document.getElementById("myAudio");
            audio.play();
            audio.volume = 0.3;
            audio.currentTime = 5;
        });
    </script>
    <script>
        let isRecording = false;
        let audioChunks = [];
        let mediaRecorderInstance;

        async function toggleRecording() {
            const recordButton = document.getElementById('recordButton');

            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorderInstance = new MediaRecorder(stream);

                mediaRecorderInstance.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorderInstance.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    console.log('Audio URL:', audioUrl);
                    audioChunks = []
                    textToAudio(audioUrl);


                };

                mediaRecorderInstance.start();
                recordButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="red" d="M9 13c.07 0 .14-.002.21-.007c.11-.387.26-.757.448-1.104A2 2 0 0 1 7 10V5.001a2 2 0 1 1 4 0v5c0 .092-.006.183-.018.272A5.47 5.47 0 0 1 12 9.601V5a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm-4.5-3A4.5 4.5 0 0 0 9 14.5c0 .819.179 1.596.5 2.294v.706a.5.5 0 0 1-1 0v-2.022A5.5 5.5 0 0 1 3.5 10a.5.5 0 0 1 1 0ZM17 14.5a2.5 2.5 0 1 1-5 0a2.5 2.5 0 0 1 5 0Zm2 0a4.5 4.5 0 1 1-9 0a4.5 4.5 0 0 1 9 0Zm-8 0a3.5 3.5 0 1 0 7 0a3.5 3.5 0 0 0-7 0Z"/></svg>';
            } else {
                mediaRecorderInstance.stop();
                recordButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="white" d="M4.5 10a.5.5 0 0 0-1 0a5.5 5.5 0 0 0 5 5.478V17.5a.5.5 0 0 0 1 0v-.706A5.48 5.48 0 0 1 9 14.5A4.5 4.5 0 0 1 4.5 10ZM12 5v4.6a5.514 5.514 0 0 0-2.79 3.393A3 3 0 0 1 6 10V5a3 3 0 0 1 6 0Zm5 9.5a2.5 2.5 0 1 1-5 0a2.5 2.5 0 0 1 5 0Zm2 0a4.5 4.5 0 1 1-9 0a4.5 4.5 0 0 1 9 0Zm-8 0a3.5 3.5 0 1 0 7 0a3.5 3.5 0 0 0-7 0Z"/></svg>';
            }

            isRecording = !isRecording;
        }
    </script>

    <script>
        function sendMessageToDjango(message) {
            var endpoint = 'chat';  // Replace with your Django server URL

            // Data to be sent in the request
            var postData = {
                message: message,
                user: username
            };

            // Make a POST request using the fetch API
            return fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // You may need to include additional headers, such as authorization headers, if required by the server
                },
                body: JSON.stringify(postData)
            })
                .then(response => {
                    // Check if the request was successful (status code 200-299)
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    // Parse the response (assuming it's JSON in this example)
                    return response.json();
                })
                .then(data => {
                    // Parse the 'message' field as JSON and return it
                    return JSON.parse(data.message);
                })
                .catch(error => {
                    // Handle errors during the fetch operation
                    console.error('Fetch error:', error);
                    throw error; // Propagate the error to the caller
                });
        }
    </script>

    <script>
        const apiKey = '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'

        async function textToAudio(audiourl) {
            const audioBlobUrl = audiourl;

            // Fetch the audio data as a Blob
            const audioBlob2 = await fetch(audioBlobUrl).then(response => response.blob());
            // Create a FormData object to handle the file upload
            const formData = new FormData();
            console.log(audioBlob2)
            formData.append('file', audioBlob2, 'audio.mp3');
            formData.append('model', 'whisper-1');

            // Set up the headers
            const headers = new Headers({
                'Authorization': `Bearer ${apiKey}`,
            });

            // Set up the fetch request
            const transcriptionResponse = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: headers,
                body: formData,
            });

            // Parse the response
            const result = await transcriptionResponse.json();
            // console.log();
            message = result.text



            var responseText;
            sendMessageToDjango(message)
                .then(async (parsedMessage) => {  // Add the async keyword here
                    // Handle the parsed message or perform any other actions
                    console.log('Parsed message:', parsedMessage.response);
                    console.log(parsedMessage.emotion);
                    console.log(parsedMessage.background_image);
                    responseText = parsedMessage.response;
                    character_image = parsedMessage.emotion;
                    body_image = parsedMessage.background_image;

                    document.getElementById('response_gpt').innerHTML = responseText;
                    document.getElementById('character_id').src = character_image;
                    document.body.style.backgroundImage = `url(${body_image})`;

                    // Use await within an asynchronous function
                    const ttsResponse = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            input: `[sound cool]${responseText}`,
                            voice: 'alloy',
                        }),
                    });

                    const audioBlob = await ttsResponse.blob();

                    // Create an audio element and set the source to the generated audio
                    const audioElement = new Audio(URL.createObjectURL(audioBlob));
                    document.body.appendChild(audioElement);

                    // Play the audio
                    audioElement.play();
                })
                .catch(error => {
                    // Handle errors from the sendMessageToDjango function
                    console.error('Error:', error);
                });

        }


    </script>
</body>

</html>